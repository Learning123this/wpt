<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Server Features &#8212; web-platform-tests  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python Handlers" href="python-handlers/index.html" />
    <link rel="prev" title="File Name Flags" href="file-names.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="server-features">
<h1>Server Features<a class="headerlink" href="#server-features" title="Link to this heading">¶</a></h1>
<p>For many tests, writing one or more static HTML files is
sufficient. However there are a large class of tests for which this
approach is insufficient, including:</p>
<ul class="simple">
<li><p>Tests that require cross-domain access</p></li>
<li><p>Tests that depend on setting specific headers or status codes</p></li>
<li><p>Tests that need to inspect the browser-sent request</p></li>
<li><p>Tests that require state to be stored on the server</p></li>
<li><p>Tests that require precise timing of the response.</p></li>
</ul>
<p>To make writing such tests possible, we are using a number of
server-side components designed to make it easy to manipulate the
precise details of the response:</p>
<ul class="simple">
<li><p><em>wptserve</em>, a custom Python HTTP server</p></li>
<li><p><em>pywebsocket</em>, an existing websockets server</p></li>
</ul>
<p>wptserve is a Python-based web server. By default it serves static
files in the test suite. For more sophisticated requirements, several
mechanisms are available to take control of the response. These are
outlined below.</p>
<section id="tests-involving-multiple-origins">
<h2>Tests Involving Multiple Origins<a class="headerlink" href="#tests-involving-multiple-origins" title="Link to this heading">¶</a></h2>
<p>Our test servers are guaranteed to be accessible through two domains
and five subdomains under each. The ‘main’ domain is unnamed; the
other is called ‘alt’. These subdomains are: <code class="docutils literal notranslate"><span class="pre">www</span></code>, <code class="docutils literal notranslate"><span class="pre">www1</span></code>, <code class="docutils literal notranslate"><span class="pre">www2</span></code>,
<code class="docutils literal notranslate"><span class="pre">天気の良い日</span></code>, and <code class="docutils literal notranslate"><span class="pre">élève</span></code>; there is also <code class="docutils literal notranslate"><span class="pre">nonexistent</span></code> which is
guaranteed not to resolve. In addition, the HTTP server listens on two
ports, and the WebSockets server on one. These subdomains and ports
must be used for cross-origin tests.</p>
<p>Tests must not hardcode the hostname of the server that they expect to
be running on or the port numbers, as these are not guaranteed by the
test environment. Instead they can get this information in one of two
ways:</p>
<ul class="simple">
<li><p>From script, using the <code class="docutils literal notranslate"><span class="pre">location</span></code> API.</p></li>
<li><p>By using a textual substitution feature of the server.</p></li>
</ul>
<p>In order for the latter to work, a file must either have a name of the form
<code class="docutils literal notranslate"><span class="pre">{name}.sub.{ext}</span></code> e.g. <code class="docutils literal notranslate"><span class="pre">example-test.sub.html</span></code> or be referenced through a URL
containing <code class="docutils literal notranslate"><span class="pre">pipe=sub</span></code> in the query string e.g. <code class="docutils literal notranslate"><span class="pre">example-test.html?pipe=sub</span></code>.
The substitution syntax uses <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">}}</span></code> to delimit items for substitution. For
example to substitute in the main host name, one would write: <code class="docutils literal notranslate"><span class="pre">{{host}}</span></code>.</p>
<p>To get full domains, including subdomains, there is the <code class="docutils literal notranslate"><span class="pre">hosts</span></code> dictionary,
where the first dimension is the name of the domain, and the second the
subdomain. For example, <code class="docutils literal notranslate"><span class="pre">{{hosts[][www]}}</span></code> would give the <code class="docutils literal notranslate"><span class="pre">www</span></code> subdomain under
the main (unnamed) domain, and <code class="docutils literal notranslate"><span class="pre">{{hosts[alt][élève]}}</span></code> would give the <code class="docutils literal notranslate"><span class="pre">élève</span></code>
subdomain under the alt domain.</p>
<p>For mostly historic reasons, the subdomains of the main domain are
also available under the <code class="docutils literal notranslate"><span class="pre">domains</span></code> dictionary; this is identical to
<code class="docutils literal notranslate"><span class="pre">hosts[]</span></code>.</p>
<p>Ports are also available on a per-protocol basis. For example,
<code class="docutils literal notranslate"><span class="pre">{{ports[ws][0]}}</span></code> is replaced with the first (and only) WebSockets port, while
<code class="docutils literal notranslate"><span class="pre">{{ports[http][1]}}</span></code> is replaced with the second HTTP port.</p>
<p>The request URL itself can be used as part of the substitution using the
<code class="docutils literal notranslate"><span class="pre">location</span></code> dictionary, which has entries matching the <code class="docutils literal notranslate"><span class="pre">window.location</span></code> API.
For example, <code class="docutils literal notranslate"><span class="pre">{{location[host]}}</span></code> is replaced by <code class="docutils literal notranslate"><span class="pre">hostname:port</span></code> for the
current request, matching <code class="docutils literal notranslate"><span class="pre">location.host</span></code>.</p>
</section>
<section id="tests-requiring-special-headers">
<h2>Tests Requiring Special Headers<a class="headerlink" href="#tests-requiring-special-headers" title="Link to this heading">¶</a></h2>
<p>For tests requiring that a certain HTTP header is set to some static
value, a file with the same path as the test file except for an an
additional <code class="docutils literal notranslate"><span class="pre">.headers</span></code> suffix may be created. For example for
<code class="docutils literal notranslate"><span class="pre">/example/test.html</span></code>, the headers file would be
<code class="docutils literal notranslate"><span class="pre">/example/test.html.headers</span></code>. This file consists of lines of the form</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">header</span><span class="o">-</span><span class="n">name</span><span class="p">:</span> <span class="n">header</span><span class="o">-</span><span class="n">value</span>
</pre></div>
</div>
<p>For example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">big5</span>
</pre></div>
</div>
<p>To apply the same headers to all files in a directory use a
<code class="docutils literal notranslate"><span class="pre">__dir__.headers</span></code> file. This will only apply to the immediate
directory and not subdirectories.</p>
<p>Headers files may be used in combination with substitutions by naming
the file e.g. <code class="docutils literal notranslate"><span class="pre">test.html.sub.headers</span></code>.</p>
</section>
<section id="tests-requiring-full-control-over-the-http-response">
<h2>Tests Requiring Full Control Over The HTTP Response<a class="headerlink" href="#tests-requiring-full-control-over-the-http-response" title="Link to this heading">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="python-handlers/index.html">Python Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="server-pipes.html">wptserve Pipes</a></li>
</ul>
</div>
<p>For full control over the request and response, the server provides the ability
to write <code class="docutils literal notranslate"><span class="pre">.asis</span></code> files; these are served as literal HTTP responses. In other
words, they are sent byte-for-byte to the server without adding an HTTP status
line, headers, or anything else. This makes them suitable for testing
situations where the precise bytes on the wire are static, and control over the
timing is unnecessary, but the response does not conform to HTTP requirements.</p>
<p>The server also provides the ability to write <a class="reference internal" href="python-handlers/index.html"><span class="doc">Python
“handlers”</span></a>–Python scripts that have access to request
data and can manipulate the content and timing of the response. Responses are
also influenced by <a class="reference internal" href="server-pipes.html"><span class="doc">the pipe query string parameter</span></a>.</p>
</section>
<section id="tests-requiring-http-2-0">
<h2>Tests Requiring HTTP/2.0<a class="headerlink" href="#tests-requiring-http-2-0" title="Link to this heading">¶</a></h2>
<p>To make a test run over an HTTP/2.0 connection, use <code class="docutils literal notranslate"><span class="pre">.h2.</span></code> in the filename.
By default the HTTP/2.0 server can be accessed using port 9000. At the moment
accessing tests that use <code class="docutils literal notranslate"><span class="pre">.h2.</span></code> over ports that do not use an HTTP/2.0 server
also succeeds, so beware of that when creating them.</p>
<p>The HTTP/2.0 server supports handlers that work per-frame; these, along with the
API are documented in <a class="reference internal" href="h2tests.html"><span class="doc">Writing H2 Tests</span></a>.</p>
</section>
<section id="tests-requiring-webtransport-over-http-3">
<h2>Tests Requiring WebTransport over HTTP/3<a class="headerlink" href="#tests-requiring-webtransport-over-http-3" title="Link to this heading">¶</a></h2>
<p>We do not support loading a test over WebTransport over HTTP/3 yet, but a test
can establish a WebTransport session to the test server.</p>
<p>The WebTransport over HTTP/3 server is not yet enabled by default, so
WebTransport tests will fail unless <code class="docutils literal notranslate"><span class="pre">--enable-webtransport</span></code> is specified to
<code class="docutils literal notranslate"><span class="pre">./wpt</span> <span class="pre">run</span></code>.</p>
</section>
<section id="test-features-specified-as-query-params">
<h2>Test Features specified as query params<a class="headerlink" href="#test-features-specified-as-query-params" title="Link to this heading">¶</a></h2>
<p>Alternatively to specifying <a class="reference external" href="file-names.html#test-features">Test Features</a> in
the test filename, they can be specified by setting the <code class="docutils literal notranslate"><span class="pre">wpt_flags</span></code> in the
<a class="reference external" href="testharness.html#variants">test variant</a>. For example, the following variant
will be loaded over HTTPS:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;variant&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;?wpt_flags=https&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">https</span></code>, <code class="docutils literal notranslate"><span class="pre">h2</span></code> and <code class="docutils literal notranslate"><span class="pre">www</span></code> features are supported by <code class="docutils literal notranslate"><span class="pre">wpt_flags</span></code>.</p>
<p>Multiple features can be specified by having multiple <code class="docutils literal notranslate"><span class="pre">wpt_flags</span></code>. For example,
the following variant will be loaded over HTTPS and run on the www subdomain.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;variant&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;wpt_flags=www&amp;wpt_flags=https&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">web-platform-tests</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../test-suite-design.html">Test Suite Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro-video-transcript.html">“Introduction to WPT” video transcript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running-tests/index.html">Running Tests</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Writing Tests</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#test-types">Test Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#submitting-tests">Submitting Tests</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#table-of-contents">Table of Contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reviewing-tests/index.html">Reviewing Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin/index.html">Project Administration</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Writing Tests</a><ul>
      <li>Previous: <a href="file-names.html" title="previous chapter">File Name Flags</a></li>
      <li>Next: <a href="python-handlers/index.html" title="next chapter">Python Handlers</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, wpt contributors.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="../_sources/writing-tests/server-features.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>